action:
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ cooldown is number and cooldown|int > 0 and
                 this.last_triggered is defined and
                 (as_timestamp(now()) - as_timestamp(this.last_triggered)) < cooldown }}
        sequence:
          - stop

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ start_stop_stream }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ use_rtsp }}"
                sequence:
                  - service: eufy_security.start_rtsp_livestream
                    data:
                      serial_number: "{{ device_serial }}"
              - conditions:
                  - condition: template
                    value_template: "{{ not use_rtsp }}"
                sequence:
                  - service: eufy_security.start_livestream
                    data:
                      serial_number: "{{ device_serial }}"
          - delay:
              seconds: "{{ warmup_delay | int }}"

  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ file_path }}"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ start_stop_stream and stop_stream_after }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ use_rtsp }}"
                sequence:
                  - service: eufy_security.stop_rtsp_livestream
                    data:
                      serial_number: "{{ device_serial }}"
              - conditions:
                  - condition: template
                    value_template: "{{ not use_rtsp }}"
                sequence:
                  - service: eufy_security.stop_livestream
                    data:
                      serial_number: "{{ device_serial }}"

  - service: "{{ notify_service }}"
    data:
      title: "{{ notify_title }}"
      message: "{{ notify_message }}"
      data:
        image: "{{ public_url }}"
        clickAction: "{{ notify_click_action if notify_click_action|length > 0 else '' }}"
